#!/usr/bin/env python3

#
# Copyright (C) 2025 Nethesis S.r.l.
# SPDX-License-Identifier: AGPL-3.0-or-later
#

'''
Helper script that retrieves info for the phonehome server.
'''

import sys
import json
import agent
import agent.facts
import uuid
from cluster import inventory
from cluster import modules

def decorate_with_ui_name(facts, rdb, base_key):
    if 'ui_name' in facts:
        return # value already present, nothing to do
    ui_name = rdb.get(base_key + '/ui_name') or ""
    facts['ui_name'] = agent.facts.pseudo_string(ui_name)

def cluster_facts():
    try:
        result = agent.tasks.run(
            agent_id='cluster',
            action='get-facts',
            extra={
                'isNotificationHidden': True,
            },
            endpoint="redis://cluster-leader"
        )
    except:
        print(agent.SD_WARNING + f"cluster/get-facts failed", file=sys.stderr)
        return None

    rdb = agent.redis_connect(use_replica=True)
    if result['exit_code'] == 0:
        facts = result['output']
        decorate_with_ui_name(facts, rdb, 'cluster')
        return facts
    else:
        print(agent.SD_WARNING + f"cluster/get-facts failed", file=sys.stderr)
        return None
 
def modules_facts():
    ret = []
    rdb = agent.redis_connect(use_replica=True)
    module_domains_relation = rdb.hgetall('cluster/module_domains') or {}
    installed_modules = modules.list_installed(rdb, skip_core_modules = False)
    instance_list = list(mi for module_instances in installed_modules.values() for mi in module_instances)

    # Collect facts from modules:
    for module in instance_list:
        minfo = {"id": module.get('id'), "version": module.get("version"), "name": module.get("module"), "node": module.get("node") } 
        minfo["user_domains"] = []
        for v in set(module_domains_relation.get(module.get('id'), '').split()):
            minfo["user_domains"].append(agent.facts.pseudo_domain(v))
        try:
            list_actions_result = agent.tasks.run(
                agent_id='module/' + module.get('id'),
                action='list-actions',
                extra={
                    'isNotificationHidden': True,
                },
                endpoint="redis://cluster-leader",
            )

            if not list_actions_result or list_actions_result['exit_code'] != 0:
                print(agent.SD_WARNING + f"module/{module.get('id')}/list-actions failed", file=sys.stderr)
                raise Exception("list-actions failed")
            
            if 'get-facts' in list_actions_result.get('output', []):

                get_facts_result = agent.tasks.run(
                    agent_id='module/' + module.get('id'),
                    action='get-facts',
                    extra={ 'isNotificationHidden': True },
                    endpoint="redis://cluster-leader",
                )

                if get_facts_result['exit_code'] != 0:
                    print(agent.SD_WARNING, f"get-facts failed for {module.get('id')}", file=sys.stderr)
                    raise Exception("get-facts failed")

                ofacts = get_facts_result['output']
                # merge info from get-facts
                minfo.update(ofacts)
        except Exception as ex:
            print(agent.SD_WARNING + "module_facts() exception:", ex, file=sys.stderr)

        decorate_with_ui_name(minfo, rdb, 'module/' + module.get('id'))
        ret.append(minfo)

    return ret

def node_facts():
    ret = {}
    rdb = agent.redis_connect(privileged=True)

    tasks = [{
        'agent_id': 'node/'+rdb.hget(key, 'NODE_ID'),
        'action': 'get-facts'
    } for key in rdb.scan_iter('node/*/environment')]

    try:
        results = agent.tasks.runp(
            tasks,
            extra={
                'isNotificationHidden': True,
            },
            endpoint="redis://cluster-leader"
        )

        for item in results:
            for key in item['output']:
                ret[key] = item['output'][key]
                decorate_with_ui_name(ret[key], rdb, 'node/' + key)
    except:
        print(agent.SD_WARNING + f"node/get-facts failed", file=sys.stderr)

    return ret

def main():
    rdb = agent.redis_connect(privileged=True)
    if not rdb.get("cluster/anon_seed"):
        # Generate and store a random seed to send anonymous data. Make
        # sure the Redis key exists before the client library uses it!
        rdb.set("cluster/anon_seed", str(uuid.uuid4()))
    anon_enforcing = not agent.facts.has_subscription(rdb)
    agent.facts.init_pseudonymization(anon_enforcing, rdb)
    facts = {
        '$schema': 'https://schema.nethserver.org/facts/2022-12.json',
        'uuid': rdb.get('cluster/uuid'),
        'installation': 'nethserver',
        'facts': {
            'cluster': cluster_facts(),
            'nodes': node_facts(),
            'modules': modules_facts()
        }
    }
    print(json.dumps(facts))

if __name__ == "__main__":
    main()