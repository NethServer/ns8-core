#!/usr/bin/env python3

#
# Copyright (C) 2025 Nethesis S.r.l.
# SPDX-License-Identifier: AGPL-3.0-or-later
#

'''
Get the facts about the cluster itself.
'''

import json
import sys
from cluster import inventory
import agent
import agent.tasks
import agent.facts
import cluster.modules

rdb = agent.redis_connect(privileged=True)

anon_enforcing = not agent.facts.has_subscription(rdb)
agent.facts.init_pseudonymization(anon_enforcing, rdb)
disabled_updates_reason = cluster.modules.get_disabled_updates_reason(rdb)
update_schedule_active = rdb.hget('cluster/apply_updates', 'is_active') == "1"

def get_user_domains_facts(rdb):
    list_user_domains_result = agent.tasks.run(
        agent_id='cluster',
        action='list-user-domains',
        extra={ 'isNotificationHidden': True },
        endpoint="redis://cluster-leader",
    )
    if list_user_domains_result['exit_code'] != 0:
        return []
    domfacts = []
    for ldom in list_user_domains_result['output']['domains']:
        odom = {
            "name": agent.facts.pseudo_domain(ldom["name"]),
            "location": ldom["location"],
            "protocol": ldom["protocol"],
            "schema": ldom.get("schema"),
            "providers_count": len(ldom["providers"]),
        }
        odom.update(inventory.fact_user_domain_counters(rdb, ldom["name"]))
        domfacts.append(odom)
    return domfacts

facts = {
    'leader_node_id': rdb.hget("cluster/environment", "NODE_ID"),
    'user_domains': get_user_domains_facts(rdb),
    'subscription': inventory.fact_subscription(rdb),
    'admins': inventory.fact_admins(rdb),
    'repositories': inventory.fact_repositories(rdb),
    'smarthost': inventory.fact_smarthost(rdb),
    "backup": inventory.fact_backup(rdb),
    'update_disabled': bool(disabled_updates_reason), # True if updates are disabled by some reason
    'update_disabled_reason': disabled_updates_reason, # For example, update inhibited by ns7_migration
    'update_schedule_active': update_schedule_active, # True if overnight automatic updates for subscription are enabled
}
json.dump(facts, fp=sys.stdout)
