#!/bin/bash

#
# Copyright (C) 2025 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#

#
# Systemd generator to limit parallel startup of lingering user sessions
# to nproc/2 chains, prioritizing core modules and respecting UID order.
#

set -e

# Generator output directory
GENERATOR_DIR="$1"
[ -z "$GENERATOR_DIR" ] && exit 0

# Core modules (higher priority)
CORE_MODULES=(
    "ldapproxy"
    "openldap"
    "samba"
    "nethvoice-proxy"
    "metrics"
    "loki"
    "traefik"
)

# Calculate number of parallel chains (nproc/2, minimum 1)
NPROC=$(nproc)
CHAINS=$((NPROC / 2))
[ "$CHAINS" -lt 1 ] && CHAINS=1

# Function to get module priority (0 = core, 1 = app)
get_module_priority() {
    local module="$1"
    for core in "${CORE_MODULES[@]}"; do
        # Match module name prefix (e.g., openldap1 matches openldap)
        if [[ "$module" =~ ^${core}[0-9]*$ ]]; then
            echo 0
            return
        fi
    done
    echo 1
}

# Collect all lingering users with their UIDs and priority
declare -a USERS_INFO
while IFS= read -r linger_file; do
    username=$(basename "$linger_file")

    # Get UID for the user
    if uid=$(id -u "$username" 2>/dev/null); then
        priority=$(get_module_priority "$username")
        USERS_INFO+=("$priority:$uid")
    fi
done < <(find /var/lib/systemd/linger/ -type f 2>/dev/null || true)

# Sort by priority (core first), then by UID
mapfile -t SORTED_USERS < <(printf '%s\n' "${USERS_INFO[@]}" | sort -t: -k1,1n -k2,2n)

# Exit if no lingering users found
[ ${#SORTED_USERS[@]} -eq 0 ] && exit 0

# Distribute users across chains round-robin
declare -a CHAINS_USERS
for i in $(seq 0 $((CHAINS - 1))); do
    CHAINS_USERS[i]=""
done

chain_idx=0
for user_info in "${SORTED_USERS[@]}"; do
    uid="${user_info##*:}"
    CHAINS_USERS[chain_idx]+="$uid "
    chain_idx=$(((chain_idx + 1) % CHAINS))
done

# Create drop-in directories and ordering for each chain
for chain_id in $(seq 0 $((CHAINS - 1))); do
    luids="${CHAINS_USERS[$chain_id]}"
    [ -z "$luids" ] && continue
    prev_user=""
    for uid in $luids; do
        # Create drop-in directory for user@.service
        dropdir="$GENERATOR_DIR/user@${uid}.service.d"
        mkdir -p "$dropdir"
        username=$(id -nu "$uid")

        # Create ordering drop-in
        {
            echo "# Generated by limit-load for $username"
            if [ -n "$prev_user" ]; then
                echo "[Unit]"
                echo "# Chain $chain_id, after $(id -nu "${prev_user}")"
                echo "After=user@${prev_user}.service"
            fi
            echo "[Service]"
            echo "# Wait up to 3 minutes until Systemd user"
            echo "# session for $username is fully started:"
            echo "TimeoutStartSec=185s"
            echo "ExecStartPost=-timeout 180s systemctl --user is-system-running --wait"
        } > "$dropdir/90-limit-load.conf"

        prev_user="$uid"
    done
done

exit 0
