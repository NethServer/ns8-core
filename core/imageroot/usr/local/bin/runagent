#!/bin/bash

#
# Copyright (C) 2021 Nethesis S.r.l.
# http://www.nethesis.it - nethserver@nethesis.it
#
# This script is part of NethServer.
#
# NethServer is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License,
# or any later version.
#
# NethServer is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with NethServer.  If not, see COPYING.
#

set -e

function usage()
{
    (
        exec 1>&2
        echo "Run COMMAND in the agent environment of MODULE_ID."
        echo "runagent [-m MODULE_ID] [-d] COMMAND [ARG ...]"
        echo "   -m MODULE_ID: \"cluster\", \"node\" (for the local node) or"
        echo "      any other module identifier rootless or rootfull (e.g. traefik1)."
        echo "      Only root can use the \"-m\" option"
        echo "   -d: Run COMMAND in current directory (instead of changing"
        echo "      to AGENT_STATE_DIR)."
        echo ""
    )
}

#
# Establish the default module id value. Can be overridden by -m
#
if [[ $EUID == 0 ]]; then
    mid=cluster
else
    mid=$(id -un)
fi

while getopts "hdm:" arg; do
  case "$arg" in
    d)
      dir_current=1
      ;;
    m)
      mid=$OPTARG
      [[ $EUID != 0 ]] && usage && exit 1
      ;;
    *)
      usage
      exit 0
      ;;
  esac
done
shift $((OPTIND-1))

if (($# == 0)); then
    usage
    exit 1
fi

agent_env=()

function read_env()
{
    local env_file="$1"
    mapfile -t -O "${#agent_env[@]}" agent_env < <(sed '/^#/d' "${env_file}")
}

function get_env()
{
    for env_item in "${agent_env[@]}"; do
        if [[ "${env_item}" =~ ^"$1"= ]]; then
            echo "${env_item#$1=}"
            return 0
        fi
    done
    return 1
}

if [[ $EUID != 0 ]]; then
    # rootless module
    home_dir=~
    read_env /etc/nethserver/agent.env
    read_env ~/.config/state/agent.env
    read_env ~/.config/state/environment
    agent_env+=(AGENT_INSTALL_DIR="${home_dir}/.config")
    agent_env+=(AGENT_STATE_DIR="${home_dir}/.config/state")
elif [[ -d "/var/lib/nethserver/${mid}" ]]; then
    # rootfull module
    read_env /etc/nethserver/agent.env
    read_env "/var/lib/nethserver/${mid}/state/agent.env"
    read_env "/var/lib/nethserver/${mid}/state/environment"
    agent_env+=(AGENT_INSTALL_DIR="/var/lib/nethserver/${mid}")
    agent_env+=(AGENT_STATE_DIR="/var/lib/nethserver/${mid}/state")
else
    echo "[FATAL] Cannot find environment for module ${mid}" 1>&2
    echo "[FATAL] Try to run the command as:   runuser -u ${mid} -- $0 $*" 1>&2
    exit 1
fi

if [[ -z "${dir_current}" ]]; then
    cd "$(get_env AGENT_STATE_DIR)"
fi

agent_env+=(AGENT_ID="$(get_env REDIS_USER)")
exec /usr/bin/env "${agent_env[@]}" "$@"
