<!--
  Copyright (C) 2023 Nethesis S.r.l.
  SPDX-License-Identifier: GPL-3.0-or-later
-->
<template>
  <cv-tile kind="standard" :light="light" class="node-card ns-card">
    <!-- overflow menu -->
    <slot name="menu"></slot>
    <!-- icon -->
    <div class="row">
      <NsSvg :svg="Chip32" />
    </div>
    <div class="row">
      <h3 class="title ellipsis">
        {{
          nodeLabel ? nodeLabel : $t("common.node") + " " + nodeId.toString()
        }}
      </h3>
    </div>
    <div class="row">
      <cv-tag v-if="isLeader" kind="green" :label="leaderLabel"></cv-tag>
      <cv-tag
        v-else-if="role === 'ns7migration'"
        kind="gray"
        :label="ns7MigrationLabel"
      ></cv-tag>
      <cv-tag v-else kind="blue" :label="workerLabel"></cv-tag>
    </div>
    <div v-if="!online" class="row offline">
      <NsInlineNotification
        kind="error"
        :title="$t('nodes.node_is_offline')"
        :showCloseButton="false"
      />
    </div>
    <div v-else-if="loading" class="row node-card-skeleton">
      <cv-skeleton-text
        :paragraph="true"
        :line-count="6"
        heading
      ></cv-skeleton-text>
    </div>
    <div
      v-else-if="!loading && online && role !== 'ns7migration'"
      class="table-wrapper"
    >
      <div class="table">
        <div class="tr fqdn-row">
          <div class="td label">{{ fqdnLabel }}</div>
          <div class="td fqdn-cell">
            <cv-interactive-tooltip
              v-if="isLongFqdn"
              alignment="center"
              direction="top"
              class="fqdn-tooltip"
            >
              <template slot="content">
                {{ fqdn }}
              </template>
              <template slot="trigger">
                <span
                  class="fqdn-ellipsis fqdn-span"
                  :style="{ fontSize: fqdnFontSize }"
                  >{{ fqdn }}</span
                >
              </template>
            </cv-interactive-tooltip>
            <span
              v-else
              class="fqdn-ellipsis fqdn-span"
              :style="{ fontSize: fqdnFontSize }"
              >{{ fqdn }}</span
            >
          </div>
        </div>
        <div class="tr">
          <div class="td label">{{ $t("nodes.node_id") }}</div>
          <div class="td">
            {{ nodeId }}
          </div>
        </div>
        <div class="tr">
          <div class="td label">{{ $t("nodes.ip_address") }}</div>
          <div class="td">
            {{ ip_address }}
          </div>
        </div>
        <div class="tr">
          <div class="td label">{{ $t("nodes.applications") }}</div>
          <div class="td">
            <cv-link @click.prevent="goToApplications">
              {{ applications }}
            </cv-link>
          </div>
        </div>
      </div>
    </div>
    <template v-if="!loading && online && role === 'ns7migration'">
      <div v-if="nodeLabel" class="tr mg-top-sm">
        <div class="td label">{{ $t("nodes.node_id") }}</div>
        <div class="td">
          {{ nodeId }}
        </div>
      </div>
      <div class="row mg-top-sm simple-field">
        <div class="mg-top-sm icon-and-text mg-bottom-lg">
          <cv-interactive-tooltip
            alignment="center"
            direction="top"
            class="icon ns-info"
          >
            <template slot="content">
              {{ $t("nodes.ns7_migration_tooltip") }}
            </template>
            <template slot="trigger">
              <NsSvg :svg="InformationFilled16" class="icon ns-info" />
            </template>
          </cv-interactive-tooltip>
          <span>{{ $t("nodes.ns7_migration_in_progress") }}</span>
        </div>
      </div>
    </template>
    <!-- alerts -->
    <template v-if="!loading && online && role !== 'ns7migration'">
      <div class="card-row icon-and-text">
        <NsSvg
          :svg="alertsCount > 0 ? Warning16 : CheckmarkFilled16"
          :class="alertsCount > 0 ? 'icon ns-warning' : 'icon ns-success'"
        />
        <span>
          <template v-if="alertsCount > 0">
            {{ alertsCount }} {{ alertsLabel }}
          </template>
          <template v-else>
            {{ $t("nodes.no_alerts") }}
          </template>
        </span>
      </div>
    </template>
    <div class="row slot">
      <slot name="content"></slot>
    </div>
  </cv-tile>
</template>

<script>
import { UtilService, IconService } from "@nethserver/ns8-ui-lib";

export default {
  name: "NodeCard",
  mixins: [UtilService, IconService],
  props: {
    nodeId: {
      type: Number,
      required: true,
    },
    nodeLabel: {
      type: String,
      default: "",
    },
    isLeader: Boolean,
    role: {
      type: String,
      default: "worker",
    },
    leaderLabel: {
      type: String,
      default: "leader",
    },
    workerLabel: {
      type: String,
      default: "worker",
    },
    ns7MigrationLabel: {
      type: String,
      default: "Migrating",
    },
    fqdn: {
      type: String,
      default: "",
    },
    fqdnLabel: {
      type: String,
      default: "FQDN",
    },
    ip_addressLabel: {
      type: String,
      default: "IP addresses",
    },
    applicationsLabel: {
      type: String,
      default: "Applications",
    },
    ip_address: {
      type: String,
      default: "",
    },
    applications: {
      type: Number,
      default: 0,
    },
    alertsCount: {
      type: Number,
      default: 0,
    },
    alertsLabel: {
      type: String,
      default: "Alerts",
    },
    online: {
      type: Boolean,
      default: true,
    },
    loading: Boolean,
    light: Boolean,
    fqdnLongThreshold: {
      type: Number,
      default: 32,
    },
  },
  data() {
    return {
      showAllDisks: false,
    };
  },
  computed: {
    isLongFqdn() {
      return this.fqdn && this.fqdn.length > this.fqdnLongThreshold;
    },
    fqdnFontSize() {
      // Use a smaller font for long FQDNs
      return this.isLongFqdn ? "0.95em" : "1.1em";
    },
  },
  methods: {
    goToApplications() {
      this.$router.push({
        path: "/applications",
        query: { selectedNodeId: this.nodeId },
      });
    },
  },
};
</script>

<style scoped lang="scss">
.node-card {
  display: flex;
  flex-direction: column;
  justify-content: center;
  min-height: 7rem;
  // needed for absolute positioning of overflow menu
  position: relative;
}

.node-card--ns7 {
  justify-content: flex-start;
  align-items: center;
}

.row {
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 0.25rem;
}

.node-card-skeleton {
  margin: 1rem 3rem;
}

.label {
  padding-right: 0.75rem;
  font-weight: bold;
  text-align: right;
  padding-bottom: 0.5rem;
}

.slot {
  margin-top: 0.5rem;
}

.offline {
  margin-top: 1rem;
}

.show-all-disks {
  text-align: center;
}

.fqdn-row {
  align-items: flex-start;
}

.fqdn-cell {
  word-break: break-all;
  white-space: normal; // allow wrapping
  overflow-wrap: anywhere; // break at any point if needed
  max-width: 100%; // prevent overflow
  text-align: left; // align text to the left for readability
  line-height: 1.3;
}

.fqdn-ellipsis,
.fqdn-span {
  display: inline-block;
  max-width: 10rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  vertical-align: bottom;
}
</style>
